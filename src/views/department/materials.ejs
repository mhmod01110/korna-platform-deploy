<%- contentFor('body') %>

<div class="container py-4">
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0"><%= department.name %> - المواد</h3>
                <div>
                    <% if (user.role === 'teacher' || user.role === 'admin') { %>
                        <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addMaterialModal">
                            <i class="fas fa-plus"></i> إضافة مواد جديدة
                        </button>
                    <% } %>
                    <a href="/" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> العودة إلى الرئيسية
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            <!-- Materials List -->
            <div class="row">
                <% if (department.materials && department.materials.length > 0) { %>
                    <% department.materials.forEach(material => { %>
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100 material-card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <h5 class="card-title mb-0">
                                            <%= material.title %>
                                        </h5>
                                        <span class="badge <%= 
                                            material.level === 'Beginner' ? 'bg-success' : 
                                            material.level === 'Normal' ? 'bg-primary' : 'bg-danger' %>">
                                            <%= material.level === 'Beginner' ? 'Beginner' : 
                                                material.level === 'Normal' ? 'Normal' : 'Advanced' %>
                                        </span>
                                    </div>
                                    
                                    <% if (material.description) { %>
                                        <p class="card-text text-muted small mb-3">
                                            <%= material.description %>
                                        </p>
                                    <% } %>
                                    
                                    <div class="d-flex justify-content-between align-items-center">
                                        <button class="btn btn-primary btn-sm view-material" 
                                                data-material-id="<%= material._id %>"
                                                data-material-title="<%= material.title %>"
                                                data-material-url="<%= material.url %>"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#viewMaterialModal">
                                            <i class="fas fa-eye me-1"></i> عرض
                                        </button>
                                        
                                        <div>
                                            <a href="<%= material.url %>" target="_blank" class="btn btn-outline-primary btn-sm me-2">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                            <% if (user.role === 'teacher' || user.role === 'admin') { %>
                                                <button class="btn btn-outline-danger btn-sm delete-material" 
                                                        data-material-id="<%= material._id %>">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            لا يوجد مواد متاحة بعد.
                        </div>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<!-- View Material Modal -->
<div class="modal fade" id="viewMaterialModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="materialTitle">عرض المواد</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="materialViewer" class="d-flex justify-content-center align-items-center" style="min-height: 400px;">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">جاري التحميل...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a id="openExternalLink" href="#" target="_blank" class="btn btn-primary">
                    <i class="fas fa-external-link-alt me-1"></i> فتح في علامة تبويب جديدة
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Material Modal -->
<% if (user.role === 'teacher' || user.role === 'admin') { %>
    <div class="modal fade" id="addMaterialModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="/departments/<%= department._id %>/materials" method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-plus-circle me-2"></i>
                            إضافة مواد دراسية
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="title" class="form-label">العنوان</label>
                            <input type="text" class="form-control" id="title" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="level" class="form-label">المستوى</label>
                            <select class="form-select" id="level" name="level" required>
                                <option value="Beginner">مبتدئ</option>
                                <option value="Normal" selected>متوسط</option>
                                <option value="Advanced">متقدم</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">مصدر المواد</label>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="sourceType" id="urlSource" value="url" checked>
                                <label class="form-check-label" for="urlSource">
                                    رابط خارجي / يوتيوب
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="sourceType" id="fileSource" value="file">
                                <label class="form-check-label" for="fileSource">
                                    رفع ملف (PDF, MP4, etc.)
                                </label>
                            </div>
                        </div>
                        <div id="urlInput" class="mb-3">
                            <label for="url" class="form-label">الرابط</label>
                            <input type="url" class="form-control" id="url" name="url" 
                                   placeholder="https://example.com or https://youtube.com/watch?v=...">
                            <div class="form-text">
                                يدعم: صفحات الويب, فيديوهات يوتيوب, روابط جوجل درايڤ, وغيرها.
                            </div>
                        </div>
                        <div id="fileInput" class="mb-3" style="display: none;">
                            <label for="file" class="form-label">File</label>
                            <input type="file" class="form-control" id="file" name="file" 
                                   accept=".pdf,.mp4,.mov,.avi,.mkv,.doc,.docx,.ppt,.pptx">
                            <div class="form-text">
                                يدعم: PDF, MP4, DOC, PPT وغيرها من التنسيقات الشائعة
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">وصف (اختياري)</label>
                            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>
                            إضافة المواد
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
<% } %>

<style>
.material-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    border: 1px solid #e0e0e0;
}

.material-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

#materialViewer {
    background: #f8f9fa;
}

.pdf-viewer {
    width: 100%;
    height: 600px;
    border: none;
}

.video-viewer {
    width: 100%;
    height: 400px;
    border: none;
}

.youtube-viewer {
    width: 100%;
    height: 400px;
    border: none;
}

.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 400px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // View Material Handler
    document.querySelectorAll('.view-material').forEach(button => {
        button.addEventListener('click', function() {
            const materialId = this.dataset.materialId;
            const materialTitle = this.dataset.materialTitle;
            const materialUrl = this.dataset.materialUrl;
            
            // Set modal title
            document.getElementById('materialTitle').textContent = materialTitle;
            document.getElementById('openExternalLink').href = materialUrl;
            
            // Show loading spinner
            const viewer = document.getElementById('materialViewer');
            viewer.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">جاري التحميل...</span>
                    </div>
                </div>
            `;
            
            // Determine file type and create appropriate viewer
            setTimeout(() => {
                const fileType = getFileType(materialUrl);
                createViewer(materialUrl, fileType);
            }, 500);
        });
    });
    
    // Delete Material Handler
    document.querySelectorAll('.delete-material').forEach(button => {
        button.addEventListener('click', async function() {
            if (confirm('Are you sure you want to delete this material?')) {
                const materialId = this.dataset.materialId;
                try {
                    const response = await fetch(`/departments/<%= department._id %>/materials/${materialId}`, {
                        method: 'DELETE',
                        headers: {
                            'CSRF-Token': '<%= csrfToken %>'
                        }
                    });
                    
                    if (response.ok) {
                        // Remove the material card
                        this.closest('.col-md-6').remove();
                        
                        // Check if no materials left
                        const remainingMaterials = document.querySelectorAll('.material-card');
                        if (remainingMaterials.length === 0) {
                            document.querySelector('.row').innerHTML = `
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        لا يوجد موات متاحة بعد.
                                    </div>
                                </div>
                            `;
                        }
                        
                        showToast('تم حذف المواد بنجاح', 'success');
                    } else {
                        throw new Error('خطأ في حذف المواد');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showToast('خطأ في حذف المواد. يرجى المحاولة مرة أخرى.', 'danger');
                }
            }
        });
    });
    
    // Source Type Toggle Handler
    document.querySelectorAll('input[name="sourceType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const urlInput = document.getElementById('urlInput');
            const fileInput = document.getElementById('fileInput');
            const urlField = document.getElementById('url');
            const fileField = document.getElementById('file');
            
            if (this.value === 'url') {
                urlInput.style.display = 'block';
                fileInput.style.display = 'none';
                urlField.required = true;
                fileField.required = false;
                fileField.value = '';
            } else {
                urlInput.style.display = 'none';
                fileInput.style.display = 'block';
                urlField.required = false;
                fileField.required = true;
                urlField.value = '';
            }
        });
    });
    
    // Form Validation Handler
    document.querySelector('#addMaterialModal form').addEventListener('submit', function(event) {
        const sourceType = document.querySelector('input[name="sourceType"]:checked').value;
        const urlField = document.getElementById('url');
        const fileField = document.getElementById('file');
        
        if (sourceType === 'url' && !urlField.value) {
            event.preventDefault();
            showToast('يرجى إدخال رابط صالح', 'danger');
            return;
        }
        
        if (sourceType === 'file' && !fileField.files[0]) {
            event.preventDefault();
            showToast('يرجى تحديد ملف', 'danger');
            return;
        }
    });
    
    // Helper Functions
    function getFileType(url) {
        // YouTube detection
        if (url.includes('youtube.com') || url.includes('youtu.be')) {
            return 'youtube';
        }
        
        // Get file extension
        const extension = url.split('.').pop().toLowerCase().split('?')[0];
        
        // File type mapping
        const typeMap = {
            'pdf': 'pdf',
            'mp4': 'video',
            'mov': 'video',
            'avi': 'video',
            'mkv': 'video',
            'webm': 'video',
            'mp3': 'audio',
            'wav': 'audio',
            'jpg': 'image',
            'jpeg': 'image',
            'png': 'image',
            'gif': 'image'
        };
        
        return typeMap[extension] || 'web';
    }
    
    function createViewer(url, fileType) {
        const viewer = document.getElementById('materialViewer');
        
        switch (fileType) {
            case 'pdf':
                viewer.innerHTML = `
                    <iframe src="${url}" class="pdf-viewer" frameborder="0">
                        <p>متصفحك لا يدعم PDF. <a href="${url}" target="_blank">تحميل الPDF</a>.</p>
                    </iframe>
                `;
                break;
                
            case 'video':
                viewer.innerHTML = `
                    <video controls class="video-viewer">
                        <source src="${url}" type="video/mp4">
                        متصفحك لا يدعم الفيديو.
                    </video>
                `;
                break;
                
            case 'youtube':
                const videoId = extractYouTubeId(url);
                if (videoId) {
                    viewer.innerHTML = `
                        <iframe src="https://www.youtube.com/embed/${videoId}" 
                                class="youtube-viewer" 
                                frameborder="0" 
                                allowfullscreen>
                        </iframe>
                    `;
                } else {
                    viewer.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            لا يمكن تحميل فيديو يوتيوب. يرجى التحقق من الرابط.
                        </div>
                    `;
                }
                break;
                
            case 'image':
                viewer.innerHTML = `
                    <img src="${url}" class="img-fluid" alt="Material Image" style="max-height: 500px;">
                `;
                break;
                
            case 'audio':
                viewer.innerHTML = `
                    <audio controls class="w-100">
                        <source src="${url}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                `;
                break;
                
            default:
                viewer.innerHTML = `
                    <iframe src="${url}" class="pdf-viewer" frameborder="0">
                        <p>لا يمكن عرض هذا المحتوى. <a href="${url}" target="_blank">فتح في علامة تبويب جديدة</a>.</p>
                    </iframe>
                `;
        }
    }
    
    function extractYouTubeId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }
    
    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `toast position-fixed bottom-0 end-0 m-3`;
        toast.innerHTML = `
            <div class="toast-header bg-${type} text-white">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                <strong class="me-auto">${type === 'success' ? 'نجاح' : 'خطأ'}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        `;
        
        document.body.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        setTimeout(() => {
            toast.remove();
        }, 5000);
    }
});
</script> 

