<%- contentFor('body') %>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>لوحة تحكم المالك</h1>
        <div class="btn-group">
            <a href="/admin/users/create" class="btn btn-primary">
                <i class="fas fa-user-plus"></i> إضافة مستخدم
            </a>
            <a href="/admin/departments" class="btn btn-info">
                <i class="fas fa-building"></i> الدروس
            </a>
            <a href="/admin/settings" class="btn btn-secondary">
                <i class="fas fa-cog"></i> الإعدادات
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">إجمالي المستخدمين</h5>
                    <h2 class="mb-0"><%= stats.totalUsers %></h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">إجمالي الاختبارات</h5>
                    <h2 class="mb-0"><%= stats.totalExams %></h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">إجمالي الدرجات</h5>
                    <h2 class="mb-0"><%= stats.totalResults %></h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">الدروس</h5>
                    <h2 class="mb-0"><%= stats.totalDepartments %></h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Links -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">روابط سريعة</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <a href="/admin/users" class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-users"></i> إدارة المستخدمين
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="/admin/reports/exams" class="btn btn-outline-success w-100 mb-2">
                                <i class="fas fa-chart-bar"></i> تقارير الاختبارات
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="/admin/reports/users" class="btn btn-outline-info w-100 mb-2">
                                <i class="fas fa-user-chart"></i> تقارير المستخدمين 
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="/admin/reports/performance" class="btn btn-outline-warning w-100 mb-2">
                                <i class="fas fa-chart-line"></i> تقارير الأداء
                            </a>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <a href="#" onclick="showPendingGrading()" class="btn btn-outline-danger w-100 mb-2">
                                <i class="fas fa-clipboard-check"></i> التقديمات قيد التقييم
                                <span class="badge bg-danger ms-2" id="pendingCount"><%= stats.pendingGrades || 0 %></span>
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="/dashboard" class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-tasks"></i> عرض جميع التقديمات
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="/exams?status=PUBLISHED" class="btn btn-outline-success w-100 mb-2">
                                <i class="fas fa-graduation-cap"></i> الاختبارات المنشورة
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Recent Users -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">أجدد المستخدمين</h5>
                    <a href="/admin/users" class="btn btn-sm btn-primary">View All</a>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <% recentUsers.forEach(user => { %>
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1"><%= user.firstName %> <%= user.lastName %></h6>
                                    <small class="text-muted">
                                        <%= new Date(user.createdAt).toLocaleDateString() %>
                                    </small>
                                </div>
                                <p class="mb-1">
                                    <span class="badge bg-secondary"><%= user.role %></span>
                                    <%= user.email %>
                                </p>
                            </div>
                        <% }); %>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Exams -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">أجدد الاختبارات</h5>
                    <a href="/exams" class="btn btn-sm btn-primary">View All</a>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <% recentExams.forEach(exam => { %>
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1"><%= exam.title %></h6>
                                    <small class="text-muted">
                                        <%= new Date(exam.createdAt).toLocaleDateString() %>
                                    </small>
                                </div>
                                <p class="mb-1">
                                    <span class="badge bg-<%= 
                                        exam.status === 'PUBLISHED' ? 'success' :
                                        exam.status === 'DRAFT' ? 'secondary' :
                                        'primary' %>">
                                        <%= exam.status %>
                                    </span>
                                    أنشئ بواسطة : <%= exam.createdBy.firstName %> <%= exam.createdBy.lastName %>
                                </p>
                            </div>
                        <% }); %>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pending Grading Modal -->
<div class="modal fade" id="pendingGradingModal" tabindex="-1" aria-labelledby="pendingGradingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pendingGradingModalLabel">التقديمات قيد التقييم</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6>عرض سريع للتقديمات التي تحتاج تقييم</h6>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshPendingGrading()">
                        <i class="fas fa-sync"></i> تحديث
                    </button>
                </div>
                <div id="pendingGradingContent">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> جارٍ التحميل...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="/dashboard" class="btn btn-primary">
                    <i class="fas fa-external-link-alt"></i> عرض جميع التقديمات
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
            </div>
        </div>
    </div>
</div>

<script>
function showPendingGrading() {
    const modal = new bootstrap.Modal(document.getElementById('pendingGradingModal'));
    modal.show();
    loadPendingGrading();
}

function loadPendingGrading() {
    fetch('/api/admin/pending-grading')
        .then(response => response.json())
        .then(data => {
            const contentDiv = document.getElementById('pendingGradingContent');
            
            if (data.success && data.submissions.length > 0) {
                let html = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>طالب</th>
                                    <th>اختبار/مشروع</th>
                                    <th>نوع</th>
                                    <th>تاريخ التقديم</th>
                                    <th>العملية</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.submissions.forEach(submission => {
                    const submissionDate = new Date(submission.submittedAt).toLocaleString();
                    const studentName = `${submission.studentId.firstName} ${submission.studentId.lastName}`;
                    const examTitle = submission.examId.title;
                    const submissionType = submission.submissionType === 'PROJECT' ? 'مشروع' : 'اختبار';
                    
                    html += `
                        <tr>
                            <td>${studentName}</td>
                            <td>${examTitle}</td>
                            <td>
                                <span class="badge bg-${submission.submissionType === 'PROJECT' ? 'info' : 'primary'}">
                                    ${submissionType}
                                </span>
                            </td>
                            <td>${submissionDate}</td>
                            <td>
                                <a href="/exams/${submission.examId._id}/submissions/${submission._id}/grade" 
                                   class="btn btn-sm btn-success">
                                    <i class="fas fa-check-circle"></i> تقييم
                                </a>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                contentDiv.innerHTML = html;
            } else {
                contentDiv.innerHTML = `
                    <div class="alert alert-success text-center">
                        <i class="fas fa-check-circle"></i> 
                        لا يوجد تقديمات تحتاج إلى تقييم في الوقت الحالي
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading pending grading:', error);
            document.getElementById('pendingGradingContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    حدث خطأ في تحميل البيانات. سيتم إعادة توجيهك إلى صفحة التقديمات.
                </div>
            `;
            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 2000);
        });
}

function refreshPendingGrading() {
    document.getElementById('pendingGradingContent').innerHTML = `
        <div class="text-center">
            <i class="fas fa-spinner fa-spin"></i> جارٍ التحديث...
        </div>
    `;
    loadPendingGrading();
}
</script> 